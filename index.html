<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NoteTakeApp</title>
    <link rel="icon" type="image/svg+xml" href="https://icons.getbootstrap.com/assets/icons/code-slash.svg" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- mark.js for highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>
    <style>
      :root {
        --header-height: 44px;
      }

      .note-card {
        cursor: pointer;
        transition: transform 0.2s;
      }

      .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .note-card:hover {
        transform: scale(1.02);
      }

      .action-btn {
        background: none;
        border: none;
        color: inherit;
      }

      .category-badge {
        font-size: 0.7em;
        background: #6c757d;
        color: #fff;
        border-radius: 0.5em;
        padding: 0.15em 0.6em;
      }

      .text-truncate {
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: middle;
      }

      @media (max-width: 991.98px) {
        #singleNoteSidebarColumn {
          display: none !important;
        }
      }

      @media (min-width: 992px) {
        #singleNoteSidebarColumn {
          display: flex !important;
        }
      }

      #singleNoteDualCol {
        min-height: 100dvh;
        max-height: 100dvh;
        width: 100vw;
        overflow: hidden;
        margin: 0;
        padding: 0;
      }

      #singleNoteSidebarColumn {
        border-right: 1px solid #343a40;
        min-width: 350px;
        max-width: 400px;
        background: #23272b;
        height: 100dvh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      #singleNoteSidebarColumn .note-card {
        margin-bottom: 0.5rem;
        border-left: 4px solid transparent;
        border-radius: 0 0.5rem 0.5rem 0;
      }

      #singleNoteSidebarColumn .note-card.active {
        border-left: 4px solid #0d6efd;
        background-color: #222b34;
      }

      #singleNoteMainColumn {
        flex: 1;
        min-width: 0;
        background: var(--bs-body-bg);
        display: flex;
        flex-direction: column;
        height: 100dvh;
        overflow: hidden;
        position: relative;
      }

      #singleNoteMainNavbar {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        background: var(--bs-secondary-bg, #f8f9fa);
        border-bottom: 1px solid #e3e3e3;
        min-height: var(--header-height);
        height: var(--header-height);
        box-sizing: border-box;
      }

      @media (max-width: 767px) {
        .search-sm {
          max-width: 160px;
        }
      }

      @media (min-width: 768px) {
        .search-sm {
          min-width: 500px;
        }
      }

      /* contenteditable note area */
      #noteContent {
        width: 100%;
        border: none;
        outline: none;
        background: #222b34;
        color: #fff;
        resize: none;
        padding: 2rem 2.5rem 2rem 2.5rem;
        font-size: 1rem;
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        box-sizing: border-box;
        height: calc(100dvh - var(--header-height));
        max-height: calc(100dvh - var(--header-height));
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* highlighted matches */
      mark {
        background: #ffee58 !important;
        color: #212529 !important;
        padding: 0;
        border-radius: 2px;
      }

      .current-match mark {
        background: #ffb74d !important;
        border: 1px solid #ff9800;
      }

      #singleNoteSidebarColumn::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }

      #singleNoteSidebarColumn {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #wordCounter {
        position: fixed;
        bottom: 0;
        right: 0;
        font-size: 13px;
        font-weight: 500;
        z-index: 1055;
        border-radius: 8px 0 0 0;
        padding: 0.3em 1.3em;
        user-select: none;
        pointer-events: none;
      }

      .single-note-card-actions {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 2;
      }

      .single-note-card-content {
        padding-right: 2.5rem;
      }

      .dropdown-item-category {
        display: flex;
        align-items: center;
        gap: 0.5em;
      }

      .categorize-selected-btn {
        margin-left: 8px;
      }

      .categories-sort-row {
        display: flex;
        gap: 12px;
        justify-content: flex-start;
        align-items: center;
        margin-bottom: 1rem;
      }

      .categories-sort-row .form-select {
        min-width: 180px;
      }

      .categories-sort-row .sort-select {
        margin-left: auto;
        min-width: 120px;
      }

      .copied-indicator {
        position: absolute;
        top: 0.5rem;
        right: 3.3rem;
        z-index: 10;
        background: #2bc48a;
        color: #fff;
        font-weight: bold;
        border-radius: 6px;
        padding: 0.15em 0.6em;
        font-size: 0.95em;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
      }

      .copied-indicator.show {
        opacity: 1;
      }

      #installButton {
        position: fixed;
        bottom: 22px;
        left: 22px;
        z-index: 2000;
        display: none;
      }

      .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin: 16px 0 0 0;
        user-select: none;
      }

      .pagination-btn {
        border: none;
        background: #23272b;
        color: #fff;
        border-radius: 6px;
        padding: 0.2em 1em;
        font-size: 1em;
        cursor: pointer;
        transition: background .15s;
      }

      .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #333;
      }

      .pagination-page {
        font-weight: bold;
        font-size: 1em;
        color: #0d6efd;
      }

      .load-more-btn {
        display: block;
        width: 90%;
        margin: 0.7em auto 1em auto;
        border: none;
        border-radius: 10px;
        background: #343a40;
        color: #fff;
        font-weight: 500;
        font-size: 1em;
        padding: 0.4em 0;
        transition: background .15s;
      }

      .load-more-btn:hover:not(:disabled) {
        background: #0d6efd;
      }

      /* Floating find bar */
      #findBar {
        position: absolute;
        top: 50px;
        right: 20px;
        width: 380px;
        max-width: calc(100vw - 40px);
        background: #2c3034;
        border: 1px solid #495057;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        z-index: 1060;
        display: none;
      }

      #findBar .form-control,
      #findBar .form-check {
        font-size: 0.9rem;
      }

      #findBar .btn-sm {
        font-size: 0.8rem;
        padding: 0.2rem 0.6rem;
      }

      #findBar .d-flex {
        gap: 6px;
      }

      @media (max-width: 480px) {
        #findBar {
          width: calc(100vw - 20px);
          right: 10px;
          left: 10px;
        }
        #findBar .d-flex {
          flex-wrap: wrap;
        }
        #findBar .btn-sm {
          flex: 1 0 auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="w-100">
      <div class="container mb-5 mt-3" id="allNotesView">
        <ul class="nav nav-tabs border-0 my-2 bg-light-subtle p-3 rounded-4 align-items-center">
          <li class="nav-item">
            <input id="searchInput" class="form-control search-sm rounded search-input w-100 border-0"
              style="padding-top: 0.48em; padding-bottom: 0.48em;" type="text" placeholder="ðŸ” Search..." />
          </li>
          <li class="nav-item ms-auto">
            <a class="nav-link active border-0 rounded" href="#" id="allNotesTab"><i class="bi bi-card-text"></i></a>
          </li>
          <li class="nav-item">
            <a class="nav-link border-0 rounded" href="#" id="favoritesTab"><i class="bi bi-star-fill"></i></a>
          </li>
          <div class="dropdown">
            <button class="btn border-0 rounded" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              &#9776;
            </button>
            <ul class="dropdown-menu rounded-4">
              <li>
                <button id="newNoteBtn" class="dropdown-item">
                  <i class="bi bi-plus-circle"></i> New Note
                </button>
              </li>
              <li>
                <button id="addCategoryBtn" class="dropdown-item dropdown-item-category">
                  <i class="bi bi-tag"></i> Add Category
                </button>
              </li>
              <div class="px-3">
                <div class="border border-2 my-2"></div>
              </div>
              <li>
                <button id="exportBtn" class="dropdown-item">
                  <i class="bi bi-download"></i> Export
                </button>
              </li>
              <li>
                <button id="importBtn" class="dropdown-item">
                  <i class="bi bi-upload"></i> Import
                </button>
              </li>
            </ul>
          </div>
        </ul>
        <div class="categories-sort-row">
          <select id="categoryFilter" class="form-select"></select>
          <select id="sortSelect" class="form-select sort-select" style="width: auto;">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
        <div id="selectedNotesActions" class="my-4" style="display: none;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="select-all-container align-items-center">
              <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
              (<label id="selectedCount">0</label> selected)
            </div>
            <div>
              <button id="categorizeSelectedBtn" class="btn btn-secondary btn-sm ms-2 categorize-selected-btn" title="Set Category">
                <i class="bi bi-tags"></i> Categorize
              </button>
              <button id="deleteSelectedBtn" class="btn btn-danger btn-sm ms-2">
                <i class="bi bi-trash3"></i> Delete
              </button>
            </div>
          </div>
        </div>
        <div id="noteList" class="list-group"></div>
        <div id="paginationContainer" class="pagination-container"></div>
      </div>

      <div id="singleNoteView" style="display: none;">
        <div id="singleNoteDualCol" class="d-flex flex-row">
          <div id="singleNoteSidebarColumn" class="d-flex flex-column vh-100 overflow-auto p-3 gap-1 bg-dark-subtle"
            style="min-width:350px;max-width:420px;">
            <div class="fw-bold mb-2">All Notes</div>
            <div id="singleNoteSidebarList" class="flex-grow-1"></div>
            <button id="sidebarLoadMoreBtn" class="load-more-btn w-100" style="display:none;">Load More...</button>
          </div>
          <div id="singleNoteMainColumn" class="flex-grow-1 d-flex flex-column">
            <div id="singleNoteMainNavbar" class="d-flex justify-content-between align-items-center bg-dark-subtle py-1 px-3">
              <div class="d-flex gap-3">
                <button id="backBtn" class="btn border-0">
                  <i class="bi bi-chevron-left link-body-emphasis" style="-webkit-text-stroke: 2px;"></i>
                </button>
                <button id="undoBtn" class="btn border-0">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </button>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span id="noteDate" class="text-muted"></span>
                <span class="mx-2 d-none d-md-block">|</span>
                <select id="noteCategorySelect" class="d-none d-md-block form-select form-select-sm w-auto ms-0"></select>
              </div>
              <div class="d-flex gap-3">
                <button id="redoBtn" class="btn border-0">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button id="findReplaceBtn" class="btn border-0" title="Find &amp; Replace">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <!-- contenteditable note area -->
            <div id="noteContent" class="form-control rounded-0 p-4 border-0 bg-dark-subtle text-light" contenteditable="true"></div>
            <!-- floating find bar -->
            <div id="findBar">
              <div class="mb-2">
                <input type="text" id="findInput" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Find..." autocomplete="off">
              </div>
              <div class="mb-2">
                <input type="text" id="replaceInput" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Replace with..." autocomplete="off">
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex gap-3">
                  <div class="form-check form-check-sm">
                    <input class="form-check-input" type="checkbox" id="caseSensitive">
                    <label class="form-check-label" for="caseSensitive">Match case</label>
                  </div>
                  <div class="form-check form-check-sm">
                    <input class="form-check-input" type="checkbox" id="wholeWord">
                    <label class="form-check-label" for="wholeWord">Whole word</label>
                  </div>
                </div>
                <button id="closeFindBar" class="btn btn-sm btn-outline-secondary py-0">âœ•</button>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button id="findPrevBtn" class="btn btn-secondary btn-sm flex-fill">Prev</button>
                <button id="findNextBtn" class="btn btn-secondary btn-sm flex-fill">Next</button>
                <button id="replaceBtn" class="btn btn-outline-primary btn-sm flex-fill">Replace</button>
                <button id="replaceAllBtn" class="btn btn-primary btn-sm flex-fill">Replace All</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="importInput" style="display: none;" accept=".json" />
    <div id="wordCounter" class="bg-light text-dark bg-opacity-50" style="display: none;">Words: 0</div>
    <button id="installButton" class="btn btn-primary shadow-lg d-none"><i class="bi bi-download"></i> Install App</button>

    <script>
      // ==================== STATE ====================
      let notes = {};
      let currentNote = null;
      let currentCategory = 'all';
      let selectedNotes = new Set();
      let filteredNoteIds = [];
      let undoStack = [];
      let redoStack = [];
      let lastRecordedContent = '';
      let autoSaveTimeout = null;
      let categories = [];
      const PAGE_SIZE = 30;
      let currentPage = 1;
      let sidebarPage = 1;
      let db = null;
      let searchTimeout = null;
      let sidebarScrollPos = 0;
      let marker = null;                // mark.js instance
      let currentMatchIndex = 0;
      let matches = [];
      let ignoreInput = false;           // to prevent undo/redo loops

      // DOM elements
      const allNotesView = document.getElementById('allNotesView');
      const singleNoteView = document.getElementById('singleNoteView');
      const noteList = document.getElementById('noteList');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const newNoteBtn = document.getElementById('newNoteBtn');
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const importInput = document.getElementById('importInput');
      const allNotesTab = document.getElementById('allNotesTab');
      const favoritesTab = document.getElementById('favoritesTab');
      const backBtn = document.getElementById('backBtn');
      const undoBtn = document.getElementById('undoBtn');
      const redoBtn = document.getElementById('redoBtn');
      const noteContent = document.getElementById('noteContent');
      const noteDate = document.getElementById('noteDate');
      const wordCounter = document.getElementById('wordCounter');
      const selectedNotesActions = document.getElementById('selectedNotesActions');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const selectedCount = document.getElementById('selectedCount');
      const categoryFilter = document.getElementById('categoryFilter');
      const singleNoteSidebarList = document.getElementById('singleNoteSidebarList');
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      const noteCategorySelect = document.getElementById('noteCategorySelect');
      const categorizeSelectedBtn = document.getElementById('categorizeSelectedBtn');
      const installButton = document.getElementById('installButton');
      const paginationContainer = document.getElementById('paginationContainer');
      const sidebarLoadMoreBtn = document.getElementById('sidebarLoadMoreBtn');
      const findReplaceBtn = document.getElementById('findReplaceBtn');

      // Find bar elements
      const findBar = document.getElementById('findBar');
      const findInput = document.getElementById('findInput');
      const replaceInput = document.getElementById('replaceInput');
      const caseSensitive = document.getElementById('caseSensitive');
      const wholeWord = document.getElementById('wholeWord');
      const findPrevBtn = document.getElementById('findPrevBtn');
      const findNextBtn = document.getElementById('findNextBtn');
      const replaceBtn = document.getElementById('replaceBtn');
      const replaceAllBtn = document.getElementById('replaceAllBtn');
      const closeFindBar = document.getElementById('closeFindBar');

      // ==================== DATABASE ====================
      async function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open('NoteTakeAppDB', 2);
          request.onupgradeneeded = e => {
            db = e.target.result;
            if (!db.objectStoreNames.contains('notes')) {
              db.createObjectStore('notes', { keyPath: 'id' }).createIndex('date', 'date');
            }
          };
          request.onsuccess = e => { db = e.target.result; resolve(); };
          request.onerror = reject;
        });
      }

      async function loadNotes() {
        await initDB();
        notes = {};
        categories = [];
        return new Promise(resolve => {
          db.transaction('notes', 'readonly').objectStore('notes').getAll().onsuccess = e => {
            e.target.result.forEach(note => {
              notes[note.id] = note;
              if (note.category && !categories.includes(note.category)) categories.push(note.category);
            });
            if (!categories.length) categories.push('all');
            resolve();
          };
        });
      }

      async function saveNoteToDB(note) {
        return new Promise(r => db.transaction('notes', 'readwrite').objectStore('notes').put(note).onsuccess = r);
      }

      async function deleteFromDB(id) {
        return new Promise(r => db.transaction('notes', 'readwrite').objectStore('notes').delete(id).onsuccess = r);
      }

      async function deleteNotesBulk(ids) {
        return new Promise(r => {
          const tx = db.transaction('notes', 'readwrite');
          const store = tx.objectStore('notes');
          let done = 0;
          ids.forEach(id => store.delete(id).onsuccess = () => { if (++done === ids.length) r(); });
        });
      }

      // ==================== RENDERING ====================
      function renderCategoryFilterDropdown() {
        categoryFilter.innerHTML = `<option value="all">All Categories</option>`;
        categories.forEach(cat => categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`);
      }

      function renderNoteCategoryDropdown(selectedCat) {
        noteCategorySelect.innerHTML = '';
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat; opt.textContent = cat;
          if (cat === selectedCat) opt.selected = true;
          noteCategorySelect.appendChild(opt);
        });
      }

      function createNote() {
        if (!categories.length) categories.push("all");
        const noteId = Date.now().toString();
        const note = { id: noteId, title: 'New Note', content: '', date: new Date().toISOString(), favorite: false, category: categories[0] || "all" };
        notes[noteId] = note;
        saveNoteToDB(note);
        currentNote = noteId;
        showSingleNote();
      }

      async function deleteNoteFromList(noteId) {
        if (!notes[noteId] || !confirm('Delete this note?')) return;
        delete notes[noteId];
        selectedNotes.delete(noteId);
        await deleteFromDB(noteId);
        updateNoteList();
        renderSingleNoteSidebarList(true);
        updateSelectedNotesUI();
        if (noteId === currentNote) {
          const arr = Object.entries(notes).sort((a,b) => new Date(b[1].date) - new Date(a[1].date));
          currentNote = arr.length ? arr[0][0] : null;
          currentNote ? showSingleNote() : showAllNotes();
        }
      }

      function toggleFavorite(noteId) {
        if (notes[noteId]) {
          notes[noteId].favorite = !notes[noteId].favorite;
          saveNoteToDB(notes[noteId]);
          updateNoteList();
          renderSingleNoteSidebarList(true);
        }
      }

      async function saveNote() {
        if (!currentNote || !notes[currentNote]) return;
        const note = notes[currentNote];
        note.content = noteContent.innerText || '';
        note.title = (note.content.split('\n')[0] || 'Untitled').trim();
        note.date = new Date().toISOString();
        note.category = noteCategorySelect.value || "all";
        await saveNoteToDB(note);
        updateNoteList();
        updateTotalWordCounter();
        renderSingleNoteSidebarList(true);
      }

      function exportNotes() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "notes_export.json";
        a.click();
      }

      function importNotes(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async ev => {
          try {
            const imported = JSON.parse(ev.target.result);
            for (let [id, n] of Object.entries(imported)) {
              if (!n.id) n.id = id;
              notes[id] = n;
            }
            const tx = db.transaction('notes', 'readwrite');
            const store = tx.objectStore('notes');
            Object.values(notes).forEach(n => store.put(n));
            await loadNotes();
            renderCategoryFilterDropdown();
            updateNoteList();
            alert('Imported successfully!');
          } catch { alert('Invalid JSON'); }
        };
        reader.readAsText(file);
      }

      function showCopiedIndicator(card) {
        let ind = card.querySelector('.copied-indicator');
        if (!ind) { ind = document.createElement('span'); ind.className = 'copied-indicator'; ind.textContent = 'Copied!'; card.appendChild(ind); }
        ind.classList.add('show');
        setTimeout(() => ind.classList.remove('show'), 1200);
      }

      function renderNoteCard(note, noteId, opts = {}) {
        const { showCheckbox = false, selected = false, showCategory = true, showActions = true, active = false, limitChars = 200 } = opts;
        const card = document.createElement('div');
        card.className = `card bg-body-tertiary mb-3 note-card border-0 rounded-3 position-relative ${!showCheckbox && showActions ? '' : 'ps-5'}`;
        if (active) card.classList.add('active');

        const body = document.createElement('div'); body.className = "card-body";
        const header = document.createElement('div'); header.className = "note-header";
        const left = document.createElement('span');
        const dateEl = document.createElement('small'); dateEl.className = "fw-medium";
        dateEl.textContent = new Date(note.date).toLocaleDateString('en-US');
        left.appendChild(dateEl);

        const btns = document.createElement('div');
        if (showActions) {
          const copy = document.createElement('button'); copy.className = 'action-btn'; copy.innerHTML = '<i class="bi bi-copy"></i>';
          copy.onclick = e => { e.stopPropagation(); navigator.clipboard.writeText(note.content || '').then(() => showCopiedIndicator(card)); };

          const dl = document.createElement('button'); dl.className = 'action-btn'; dl.innerHTML = '<i class="bi bi-download"></i>';
          dl.onclick = e => {
            e.stopPropagation();
            const suggested = (note.content.split('\n')[0] || 'Untitled').trim().slice(0, 40) || "Untitled";
            const fn = prompt("Filename:", suggested);
            if (fn === null) return;
            const clean = (fn || "Untitled").trim() || "Untitled";
            const blob = new Blob([note.content || ''], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = clean + ".txt";
            a.click();
            URL.revokeObjectURL(a.href);
          };

          const fav = document.createElement('button'); fav.className = 'action-btn'; fav.innerHTML = `<i class="bi ${note.favorite ? 'bi-star-fill' : 'bi-star'}"></i>`;
          fav.onclick = e => { e.stopPropagation(); toggleFavorite(noteId); };

          const del = document.createElement('button'); del.className = 'action-btn'; del.innerHTML = '<i class="bi bi-trash3-fill"></i>';
          del.onclick = e => { e.stopPropagation(); deleteNoteFromList(noteId); };

          btns.append(copy, dl, fav, del);
        }
        header.append(left, btns);

        const catRow = document.createElement('div'); catRow.className = "mt-1";
        if (showCategory && note.category) {
          const cat = document.createElement('span'); cat.className = "category-badge text-truncate";
          cat.textContent = note.category; cat.title = note.category;
          catRow.appendChild(cat);
        }

        const contentDiv = document.createElement('div'); contentDiv.className = 'mt-3 text-light-emphasis';
        contentDiv.textContent = (note.content || '').substring(0, limitChars) + ((note.content || '').length > limitChars ? '...' : '');

        if (showCheckbox) {
          const cbDiv = document.createElement('div'); cbDiv.className = "position-absolute top-50 start-0 translate-middle-y ms-4";
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className = 'form-check-input';
          cb.checked = selected;
          cb.onchange = e => { e.stopPropagation(); if (cb.checked) selectedNotes.add(noteId); else selectedNotes.delete(noteId); updateSelectedNotesUI(); };
          cbDiv.appendChild(cb); card.appendChild(cbDiv);
        }

        body.append(header, catRow, contentDiv);
        card.appendChild(body);

        if (showActions) {
          btns.className = "single-note-card-actions";
          body.classList.add("single-note-card-content");
          if (!card.querySelector('.copied-indicator')) {
            const ind = document.createElement('span'); ind.className = 'copied-indicator'; ind.textContent = 'Copied!';
            card.appendChild(ind);
          }
        }
        return card;
      }

      function getFilteredNotesArr() {
        const q = (searchInput.value || '').toLowerCase().trim();
        const cat = categoryFilter.value;
        let arr = Object.entries(notes).filter(([_, n]) => {
          const matchSearch = !q || (n.title || '').toLowerCase().includes(q) || (n.content || '').toLowerCase().includes(q);
          return matchSearch && (cat === 'all' || n.category === cat) && (currentCategory !== 'favorites' || n.favorite);
        });
        arr.sort((a, b) => sortSelect.value === 'newest' ? new Date(b[1].date) - new Date(a[1].date) : new Date(a[1].date) - new Date(b[1].date));
        return arr;
      }

      function updateNoteList() {
        noteList.innerHTML = '';
        const frag = document.createDocumentFragment();
        const arr = getFilteredNotesArr();
        filteredNoteIds = arr.map(([id]) => id);
        const pageStart = (currentPage - 1) * PAGE_SIZE;
        arr.slice(pageStart, pageStart + PAGE_SIZE).forEach(([id, n]) => {
          const c = renderNoteCard(n, id, { showCheckbox: true, selected: selectedNotes.has(id), showCategory: true, showActions: true });
          c.onclick = e => { if (!e.target.closest('button') && !e.target.closest('input[type="checkbox"]')) { currentNote = id; showSingleNote(); } };
          frag.appendChild(c);
        });
        noteList.appendChild(frag);
        renderPagination(arr.length);
        updateSelectedNotesUI();
      }

      function renderPagination(total) {
        paginationContainer.innerHTML = '';
        const pages = Math.ceil(total / PAGE_SIZE) || 1;
        if (pages <= 1) return;
        const p = document.createElement('button'); p.className = 'pagination-btn'; p.innerHTML = '&lt;'; p.disabled = currentPage <= 1;
        p.onclick = () => { currentPage = Math.max(1, currentPage - 1); updateNoteList(); };
        paginationContainer.appendChild(p);

        const txt = document.createElement('span'); txt.className = 'pagination-page'; txt.textContent = `${currentPage}/${pages}`;
        txt.onclick = () => {
          const np = parseInt(prompt(`Page 1-${pages}`, currentPage), 10);
          if (np && np >= 1 && np <= pages) { currentPage = np; updateNoteList(); }
        };
        paginationContainer.appendChild(txt);

        const n = document.createElement('button'); n.className = 'pagination-btn'; n.innerHTML = '&gt;'; n.disabled = currentPage >= pages;
        n.onclick = () => { currentPage = Math.min(pages, currentPage + 1); updateNoteList(); };
        paginationContainer.appendChild(n);
      }

      function getFilteredSidebarArr() {
        const q = (searchInput.value || '').toLowerCase().trim();
        const cat = categoryFilter.value;
        let arr = Object.entries(notes).filter(([_, n]) => {
          return (!q || (n.title || '').toLowerCase().includes(q) || (n.content || '').toLowerCase().includes(q)) &&
                 (cat === 'all' || n.category === cat);
        });
        arr.sort((a, b) => sortSelect.value === 'newest' ? new Date(b[1].date) - new Date(a[1].date) : new Date(a[1].date) - new Date(b[1].date));
        return arr;
      }

      function renderSingleNoteSidebarList(reset = false) {
        if (reset) { sidebarPage = 1; sidebarScrollPos = singleNoteSidebarList.scrollTop || 0; }
        singleNoteSidebarList.innerHTML = '';
        const frag = document.createDocumentFragment();
        const arr = getFilteredSidebarArr();
        arr.slice(0, sidebarPage * PAGE_SIZE).forEach(([id, n]) => {
          const c = renderNoteCard(n, id, { showCheckbox: false, showCategory: true, showActions: true, active: id === currentNote });
          c.onclick = e => { if (!e.target.closest('button')) { currentNote = id; showSingleNote(); } };
          frag.appendChild(c);
        });
        singleNoteSidebarList.appendChild(frag);
        sidebarLoadMoreBtn.style.display = arr.length > sidebarPage * PAGE_SIZE ? '' : 'none';
        singleNoteSidebarList.scrollTop = sidebarScrollPos;
      }

      function updateSelectedNotesUI() {
        selectedNotesActions.style.display = Object.keys(notes).length ? 'block' : 'none';
        selectedCount.textContent = selectedNotes.size;
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = filteredNoteIds.length && selectedNotes.size === filteredNoteIds.length;
          selectAllCheckbox.indeterminate = selectedNotes.size > 0 && selectedNotes.size < filteredNoteIds.length;
        }
      }

      async function deleteSelectedNotes() {
        if (!selectedNotes.size || !confirm(`Delete ${selectedNotes.size} notes?`)) return;
        const ids = [...selectedNotes];
        ids.forEach(id => delete notes[id]);
        await deleteNotesBulk(ids);
        selectedNotes.clear();
        updateSelectedNotesUI();
        updateNoteList();
      }

      function categorizeSelectedNotes() {
        if (!selectedNotes.size) return;
        let cat = prompt('Category for selected notes:', '');
        cat = (cat || '').trim();
        if (!cat) return;
        if (!categories.includes(cat)) { categories.push(cat); renderCategoryFilterDropdown(); }
        selectedNotes.forEach(id => { if (notes[id]) notes[id].category = cat; });
        Object.values(notes).forEach(n => saveNoteToDB(n));
        updateNoteList();
        renderSingleNoteSidebarList(true);
      }

      function updateTotalWordCounter() {
        wordCounter.style.display = singleNoteView.style.display === 'block' ? 'block' : 'none';
        const w = (noteContent.innerText || '').trim().split(/\s+/).filter(Boolean).length;
        wordCounter.textContent = `Words: ${w}`;
      }

      function showAllNotes() {
        allNotesView.style.display = 'block';
        singleNoteView.style.display = 'none';
        currentNote = null;
        wordCounter.style.display = 'none';
        findBar.style.display = 'none';
        updateNoteList();
      }

      function showSingleNote() {
        allNotesView.style.display = 'none';
        singleNoteView.style.display = 'block';
        if (!currentNote || !notes[currentNote]) return;
        const n = notes[currentNote];
        noteDate.textContent = new Date(n.date).toLocaleDateString('en-US');
        noteContent.innerText = n.content || '';
        renderNoteCategoryDropdown(n.category);
        undoStack = [];
        redoStack = [];
        lastRecordedContent = noteContent.innerText;
        updateTotalWordCounter();
        renderSingleNoteSidebarList(true);
        noteContent.focus();
        if (!marker) {
          marker = new Mark(noteContent);
        }
        findBar.style.display = 'none';
      }

      function addCategory() {
        let name = prompt("New category:", "");
        name = (name || '').trim();
        if (!name || categories.includes(name)) return alert("Invalid or duplicate");
        categories.push(name);
        renderCategoryFilterDropdown();
        renderNoteCategoryDropdown(noteCategorySelect.value);
      }

      // ==================== UNDO/REDO (CUSTOM) ====================
      function recordUndoState() {
        if (ignoreInput) return;
        const current = noteContent.innerText;
        if (current !== lastRecordedContent) {
          undoStack.push(lastRecordedContent);
          lastRecordedContent = current;
          redoStack = [];
        }
      }

      function undo() {
        if (undoStack.length) {
          ignoreInput = true;
          redoStack.push(noteContent.innerText);
          noteContent.innerText = undoStack.pop();
          lastRecordedContent = noteContent.innerText;
          saveNote();
          updateTotalWordCounter();
          if (findBar.style.display === 'block') highlightAllMatches();
          ignoreInput = false;
        }
      }

      function redo() {
        if (redoStack.length) {
          ignoreInput = true;
          undoStack.push(noteContent.innerText);
          noteContent.innerText = redoStack.pop();
          lastRecordedContent = noteContent.innerText;
          saveNote();
          updateTotalWordCounter();
          if (findBar.style.display === 'block') highlightAllMatches();
          ignoreInput = false;
        }
      }

      // Intercept browser undo/redo
      noteContent.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undo();
        } else if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          redo();
        }
      });

      // ==================== FIND & REPLACE (mark.js) ====================
      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function getFindRegex() {
        let str = findInput.value.trim();
        if (!str) return null;
        let flags = 'g';
        if (!caseSensitive.checked) flags += 'i';
        let pattern = escapeRegExp(str);
        if (wholeWord.checked) pattern = '\\b' + pattern + '\\b';
        try {
          return new RegExp(pattern, flags);
        } catch (e) {
          return null;
        }
      }

      function highlightAllMatches() {
        if (!marker) return;
        marker.unmark();
        const regex = getFindRegex();
        if (!regex) {
          matches = [];
          return;
        }
        marker.markRegExp(regex, {
          element: 'mark',
          className: '',
          each: () => { },
          done: (count) => {
            matches = Array.from(noteContent.querySelectorAll('mark'));
            currentMatchIndex = 0;
            highlightCurrentMatch();
          }
        });
      }

      function highlightCurrentMatch() {
        document.querySelectorAll('.current-match').forEach(el => el.classList.remove('current-match'));
        if (matches.length && currentMatchIndex >= 0 && currentMatchIndex < matches.length) {
          const current = matches[currentMatchIndex];
          current.classList.add('current-match');
          current.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      }

      function findNext() {
        if (!matches.length) {
          highlightAllMatches();
          if (!matches.length) { alert('No matches'); return; }
        }
        currentMatchIndex = (currentMatchIndex + 1) % matches.length;
        highlightCurrentMatch();
      }

      function findPrev() {
        if (!matches.length) {
          highlightAllMatches();
          if (!matches.length) { alert('No matches'); return; }
        }
        currentMatchIndex = (currentMatchIndex - 1 + matches.length) % matches.length;
        highlightCurrentMatch();
      }

      function doReplace() {
        if (!matches.length) {
          findNext();
          if (!matches.length) return;
        }
        const current = matches[currentMatchIndex];
        if (!current) return;
        const replaceText = replaceInput.value;
        // replace the content of this mark
        const textNode = current.firstChild;
        if (textNode && textNode.nodeType === Node.TEXT_NODE) {
          const regex = getFindRegex();
          if (!regex) return;
          const before = textNode.textContent;
          const after = before.replace(regex, replaceText);
          textNode.textContent = after;
          // merge adjacent text nodes
          current.parentNode.normalize();
          // record undo state
          recordUndoState();
          saveNote();
          // re-highlight
          highlightAllMatches();
        }
      }

      function doReplaceAll() {
        const regex = getFindRegex();
        if (!regex) return;
        const content = noteContent.innerText;
        const newContent = content.replace(regex, replaceInput.value);
        if (newContent !== content) {
          ignoreInput = true;
          noteContent.innerText = newContent;
          ignoreInput = false;
          recordUndoState();
          saveNote();
          highlightAllMatches();
        }
      }

      function toggleFindBar() {
        if (findBar.style.display === 'none' || findBar.style.display === '') {
          findBar.style.display = 'block';
          findInput.focus();
          highlightAllMatches();
        } else {
          findBar.style.display = 'none';
          if (marker) marker.unmark();
        }
      }

      // ==================== EVENT LISTENERS ====================
      function setupEventListeners() {
        categoryFilter.onchange = () => { currentPage = 1; updateNoteList(); renderSingleNoteSidebarList(true); };
        allNotesTab.onclick = e => { e.preventDefault(); currentCategory = 'all'; allNotesTab.classList.add('active'); favoritesTab.classList.remove('active'); currentPage = 1; updateNoteList(); };
        favoritesTab.onclick = e => { e.preventDefault(); currentCategory = 'favorites'; favoritesTab.classList.add('active'); allNotesTab.classList.remove('active'); currentPage = 1; updateNoteList(); };
        sortSelect.onchange = () => { currentPage = 1; updateNoteList(); renderSingleNoteSidebarList(true); };

        searchInput.oninput = () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            currentPage = 1;
            updateNoteList();
            if (singleNoteView.style.display === 'block') renderSingleNoteSidebarList(true);
          }, 250);
        };

        newNoteBtn.onclick = createNote;
        exportBtn.onclick = exportNotes;
        importBtn.onclick = () => importInput.click();
        importInput.onchange = importNotes;
        backBtn.onclick = showAllNotes;

        selectAllCheckbox.onchange = () => {
          if (selectAllCheckbox.checked) filteredNoteIds.forEach(id => selectedNotes.add(id));
          else selectedNotes.clear();
          updateNoteList();
          updateSelectedNotesUI();
        };
        deleteSelectedBtn.onclick = deleteSelectedNotes;
        categorizeSelectedBtn.onclick = categorizeSelectedNotes;

        noteContent.oninput = () => {
          if (ignoreInput) return;
          recordUndoState();
          clearTimeout(autoSaveTimeout);
          autoSaveTimeout = setTimeout(saveNote, 280);
          updateTotalWordCounter();
          if (findBar.style.display === 'block') highlightAllMatches();
        };

        undoBtn.onclick = undo;
        redoBtn.onclick = redo;

        addCategoryBtn.onclick = addCategory;
        sidebarLoadMoreBtn.onclick = () => { sidebarPage++; renderSingleNoteSidebarList(); };

        findReplaceBtn.onclick = toggleFindBar;
        closeFindBar.onclick = toggleFindBar;

        findInput.addEventListener('input', highlightAllMatches);
        caseSensitive.addEventListener('change', highlightAllMatches);
        wholeWord.addEventListener('change', highlightAllMatches);

        findNextBtn.onclick = findNext;
        findPrevBtn.onclick = findPrev;
        replaceBtn.onclick = doReplace;
        replaceAllBtn.onclick = doReplaceAll;
      }

      // ==================== PWA INSTALL ====================
      let deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; installButton.style.display = 'block'; });
      installButton.onclick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installButton.style.display = 'none';
        }
      };

      function registerServiceWorkerInline() {
        if ('serviceWorker' in navigator) {
          const sw = `const CACHE='notetakeapp-v5';self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/','https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css']))));`;
          navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], { type: 'application/javascript' })));
        }
      }

      // ==================== INIT ====================
      async function init() {
        await loadNotes();
        renderCategoryFilterDropdown();
        renderNoteCategoryDropdown("all");
        updateNoteList();
        setupEventListeners();
        registerServiceWorkerInline();
      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>